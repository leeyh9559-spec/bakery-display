<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>深夜工坊 - 远程看板</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --deep-green: #2F6F5E; --creamy-yellow: #FBEBD6; --accent-orange: #F59E6F; --accent-red: #D32F2F; }
        body { background-color: var(--deep-green); color: var(--creamy-yellow); font-family: sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        /* 布局控制 */
        #display-mode { display: none; width: 100%; text-align: center; padding: 20px; }
        #control-mode { display: none; width: 100%; padding: 20px; box-sizing: border-box; }

        /* 显示端样式 */
        .logo { max-height: 180px; margin-bottom: 20px; }
        #timer-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 25px; }
        .timer-card { background: var(--creamy-yellow); color: var(--deep-green); padding: 25px; width: 350px; border-radius: 15px; border: 4px solid var(--accent-orange); box-shadow: 10px 10px 0px rgba(0,0,0,0.3); animation: bounceIn 0.5s; position: relative; }
        .product-name { font-size: 1.8rem; font-weight: bold; }
        .time-left { font-size: 4rem; font-family: monospace; font-weight: 900; }
        .finished { background: var(--accent-red) !important; color: white !important; animation: blink 0.8s infinite; }

        /* 控制端按钮 */
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; max-width: 600px; margin: 0 auto; }
        .btn { padding: 20px; font-size: 1.1rem; border: none; border-radius: 10px; background: var(--accent-orange); color: var(--deep-green); font-weight: bold; cursor: pointer; }
        .btn:active { transform: scale(0.95); }
        .mode-hint { margin-top: 20px; font-size: 0.8rem; opacity: 0.6; }

        @keyframes bounceIn { from { opacity: 0; transform: scale(0.5); } to { opacity: 1; transform: scale(1); } }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    </style>
</head>
<body>

    <div id="display-mode">
        <img src="image_3.png" class="logo" alt="Logo">
        <div id="timer-container"></div>
    </div>

    <div id="control-mode">
        <h2 style="text-align:center">深夜工坊 · 遥控面板</h2>
        <div class="btn-grid" id="button-list"></div>
        <button onclick="sendClear()" style="width:100%; margin-top:30px; padding:15px; background:#555; color:white; border:none; border-radius:10px;">清空电视屏幕</button>
    </div>

    <script>
        // ======= 【配置区：请填入你在 Supabase 获取的值】 =======
        const SB_URL = "你的_PROJECT_URL";
        const SB_KEY = "你的_ANON_KEY";
        // =====================================================

        const supabase = nominations.createClient(SB_URL, SB_KEY);
        const urlParams = new URLSearchParams(window.location.search);
        const isControl = urlParams.has('mode') && urlParams.get('mode') === 'control';

        // 产品列表
        const products = [
            {n: '原味蛋挞', t: 18}, {n: '斑斓蛋挞', t: 18}, {n: '叉烧鸡乱乱包', t: 20},
            {n: '竹炭焦糖蛋挞', t: 20}, {n: '法式焦糖蛋挞', t: 20}, {n: '蝴蝶酥', t: 6},
            {n: '香肠港式酥饼', t: 20}, {n: '咖喱鸡肉酥', t: 20}, {n: '黑胡椒鸡肉派', t: 20},
            {n: '牛油老婆饼', t: 20}, {n: '牛油老公饼', t: 20}
        ];

        // 初始化界面
        if (isControl) {
            document.getElementById('control-mode').style.display = 'block';
            const list = document.getElementById('button-list');
            products.forEach(p => {
                const b = document.createElement('button');
                b.className = 'btn';
                b.innerText = `${p.n}\n(${p.t}m)`;
                b.onclick = () => sendTimer(p.n, p.t);
                list.appendChild(b);
            });
        } else {
            document.getElementById('display-mode').style.display = 'block';
        }

        // --- 实时通讯逻辑 ---
        const channel = supabase.channel('bakery_room');

        // 发送指令
        function sendTimer(name, mins) {
            channel.send({ type: 'broadcast', event: 'new_timer', payload: { name, mins, id: Date.now() } });
            alert('已发送给电视！');
        }
        function sendClear() {
            channel.send({ type: 'broadcast', event: 'clear_all', payload: {} });
        }

        // 接收指令 (显示端)
        channel.on('broadcast', { event: 'new_timer' }, ({ payload }) => {
            if (!isControl) startTimer(payload.name, payload.mins, payload.id);
        }).on('broadcast', { event: 'clear_all' }, () => {
            if (!isControl) document.getElementById('timer-container').innerHTML = '';
        }).subscribe();

        // 倒计时逻辑
        function startTimer(name, mins, id) {
            const container = document.getElementById('timer-container');
            let sec = mins * 60;
            const card = document.createElement('div');
            card.className = 'timer-card';
            card.innerHTML = `<div class="product-name">${name}</div><div class="time-left">--:--</div>`;
            container.appendChild(card);

            const itv = setInterval(() => {
                sec--;
                const disp = card.querySelector('.time-left');
                if (sec <= 0) {
                    clearInterval(itv);
                    disp.innerText = "新鲜出炉！";
                    card.classList.add('finished');
                } else {
                    const m = Math.floor(sec/60).toString().padStart(2,'0');
                    const s = (sec%60).toString().padStart(2,'0');
                    disp.innerText = `${m}:${s}`;
                }
            }, 1000);
        }
    </script>
</body>
</html>
